{{define "content"}}
<section class="card">
  <h2>Grafana Orgs</h2>
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Grafana Org ID</th>
        <th>Name</th>
        <th>Default Role</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {{range .Orgs}}
      <tr>
        <td>{{.ID}}</td>
        <td>{{.GrafanaOrgID}}</td>
        <td>{{.Name}}</td>
        <td>{{.DefaultRole}}</td>
        <td>
          <form action="/orgs/delete" method="post">
            <input type="hidden" name="id" value="{{.ID}}" />
            <button type="submit" class="ghost">Delete</button>
          </form>
        </td>
      </tr>
      {{else}}
      <tr>
        <td colspan="5" class="muted">No orgs yet.</td>
      </tr>
      {{end}}
    </tbody>
  </table>

  <h3>Add org</h3>
  <form action="/orgs" method="post" class="grid">
    <label>
      <span>Grafana Org ID</span>
      <input type="number" name="grafana_org_id" required />
    </label>
    <label>
      <span>Name</span>
      <input type="text" name="name" />
    </label>
    <label>
      <span>Default Role</span>
      <select name="default_role">
        <option>Viewer</option>
        <option>Editor</option>
        <option>Admin</option>
      </select>
    </label>
    <button type="submit" class="primary">Add org</button>
  </form>
</section>

<section class="card">
  <h2>Group to Team Mappings</h2>
  <div class="actions">
    <form action="/mappings/purge" method="post">
      <button type="submit" class="ghost">Purge non-matching Entra groups</button>
    </form>
  </div>
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Org</th>
        <th>Grafana Team</th>
        <th>Team ID</th>
        <th>Entra Group ID</th>
        <th>Entra Group Name</th>
        <th>Team Role</th>
        <th>Org Role</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {{range .Mappings}}
      <tr>
        <td>{{.ID}}</td>
        <td>{{.OrgID}}</td>
        <td>{{.GrafanaTeamName}}</td>
        <td>{{.GrafanaTeamID}}</td>
        <td>{{.ExternalGroupID}}</td>
        <td>{{.ExternalGroupName}}</td>
        <td>{{if .TeamRole}}{{.TeamRole}}{{else}}member{{end}}</td>
        <td>{{if .RoleOverride}}{{.RoleOverride}}{{else}}(org default){{end}}</td>
        <td>
          <form action="/mappings/delete" method="post">
            <input type="hidden" name="id" value="{{.ID}}" />
            <button type="submit" class="ghost">Delete</button>
          </form>
        </td>
      </tr>
      {{else}}
      <tr>
        <td colspan="9" class="muted">No mappings yet.</td>
      </tr>
      {{end}}
    </tbody>
  </table>

  <h3>Add mapping</h3>
  <form action="/mappings" method="post" class="grid">
    <label>
      <span>Org</span>
      <select name="org_id" required data-role="org-select">
        {{range .Orgs}}
        <option value="{{.ID}}" data-grafana-org="{{.GrafanaOrgID}}">{{.GrafanaOrgID}} - {{.Name}}</option>
        {{end}}
      </select>
    </label>
    <label>
      <span>Grafana Team Name</span>
      <select name="grafana_team_name" required data-role="team-select">
        <option value="">Select team...</option>
        {{range .GrafanaTeams}}
        <option value="{{.TeamName}}" data-org="{{.OrgID}}">{{.OrgID}} - {{.TeamName}}</option>
        {{end}}
      </select>
    </label>
    <label>
      <span>Entra Group Name</span>
      <select name="external_group_name" required data-role="group-name-select">
        <option value="">Select group...</option>
        {{range .EntraGroups}}
        <option value="{{.DisplayName}}" data-id="{{.ID}}">{{.DisplayName}}</option>
        {{end}}
      </select>
    </label>
    <input type="hidden" name="external_group_id" data-role="group-id-input" />
    <label>
      <span>Team Role</span>
      <select name="team_role">
        <option value="member">Member</option>
        <option value="admin">Admin</option>
      </select>
    </label>
    <label>
      <span>Org Role Override</span>
      <select name="role_override">
        <option value="">(org default)</option>
        <option>Viewer</option>
        <option>Editor</option>
        <option>Admin</option>
      </select>
    </label>
    <button type="submit" class="primary">Add mapping</button>
  </form>
</section>

<script>
  (function () {
    const orgSelect = document.querySelector('[data-role="org-select"]');
    const teamSelect = document.querySelector('[data-role="team-select"]');
    const groupIdInput = document.querySelector('[data-role="group-id-input"]');
    const groupNameSelect = document.querySelector('[data-role="group-name-select"]');

    const filterTeams = () => {
      if (!orgSelect || !teamSelect) return;
      const orgLabel = orgSelect.options[orgSelect.selectedIndex];
      const orgID = orgLabel ? orgLabel.dataset.grafanaOrg : "";
      Array.from(teamSelect.options).forEach((opt) => {
        if (!opt.value) return;
        opt.hidden = orgID && opt.dataset.org !== orgID;
      });
      if (teamSelect.selectedOptions.length && teamSelect.selectedOptions[0].hidden) {
        teamSelect.value = "";
      }
    };

    if (orgSelect) {
      orgSelect.addEventListener("change", filterTeams);
      filterTeams();
    }
    if (groupIdInput && groupNameSelect) {
      const syncGroupID = () => {
        const selected = groupNameSelect.selectedOptions[0];
        groupIdInput.value = selected ? selected.dataset.id || "" : "";
      };
      groupNameSelect.addEventListener("change", syncGroupID);
      syncGroupID();
    }
  })();
</script>

{{if .Plan}}
<section class="card">
  <h2>Planned Actions (Grouped)</h2>
  <form action="/sync/apply-selected" method="post">
    {{if .PlanGroups}}
    {{range .PlanGroups}}
    <div class="group-block">
      <h3>{{.Title}}</h3>
      <table>
        <thead>
          <tr>
            <th></th>
            <th>Action</th>
            <th>Email</th>
            <th>Org Role</th>
            <th>Team Role</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody>
          {{range .Actions}}
          <tr class="{{.Class}}">
            <td>
              <input type="checkbox" name="action_id" value="{{.ID}}" {{if not .Selectable}}disabled{{end}} />
            </td>
            <td>{{actionLabel .Type}}</td>
            <td>{{.Email}}</td>
            <td>{{.Role}}</td>
            <td>{{.TeamRole}}</td>
            <td>{{.Note}}</td>
          </tr>
          {{else}}
          <tr>
            <td colspan="6" class="muted">No actions in this group.</td>
          </tr>
          {{end}}
        </tbody>
      </table>
    </div>
    {{end}}
    <button type="submit" class="primary">Apply selected</button>
    {{else}}
    <p class="muted">No actions in plan.</p>
    {{end}}
  </form>
</section>
{{end}}
{{end}}
